---
title: "Results"
---

## Mock scenarios

### Quality control

After quality control, there was considerable read loss across the fungal taxa used to construct the mock scenarios (@tbl-samplesheet).
A minimum of 2500 reads per taxa was required to construct even-abundance mock scenarios with library sizes nearing 150K reads
($58 \text{ taxa} \times 2500 \text{ reads} = 145000\text{ reads}$).
This can be seen in @fig-readCountDistributionBySample, where seven samples are excluded.

::: {#fig-readCountDistributionBySample}
```{r}
knitr::include_graphics('analysis/images/06-read-count-distribution-by-sample.png')
```

The distribution of read counts per sample before (A) and after (B) quality control processing. Reads having less than 2500 reads were excluded from mock scenarios (dotted line in B). Note the x-axis is on a log scale.
:::

Tracking read counts at each stage of the pipeline has shown that the majority of reads were lost in the primer trimming and quality filtering stages of the pipeline (@fig-readLossByStage).
An average of 32.37% of reads were lost across samples after applying cutadapt to select and trim amplicons that contain both forward (ITS1F) and reverse primer (LR3) sequences.
The extraction of the full ITS region led to an average loss of 10.65% trimmed reads across samples.
An average of 71.82% of full ITS sequences were lost after selecting reads between 300-6000bp in length and having a mean quality score above Q20 (Phred scale).
Such large loss of reads can be attributed to many of the reads from the dataset being below the minimum mean quality threshold of Q20 (@fig-rawReadQuality).

::: {#fig-readLossByStage}
```{r}
knitr::include_graphics('analysis/images/06-read-loss-by-stage-by-sample.png')
```

Read loss for taxa used in mock scenarios at filtering and trimming stages of the pipeline.
Each point represents a fungal isolate sample.
Taxa that were excluded from downstream mock scenarios due to low read count have been coloured red.
The blue horizontal bar with percentages indicate the mean proportion of reads lost from the previous step.
The mean proportion of read loss was only calculated for samples that were not excluded from downstream scenarios.
Each step was executed in order from left to right.
:::

:::{#fig-rawReadQuality}

![](analysis/images/06-raw-read-quality.png)

Mean read quality of reads from 58 fungal taxa before trimming or filtering steps.
The raw reads have been produced by a MinION R10.4 flow cell after basecalling with Guppy v6.4.2 (super-high accuracy model).
Quality scores are in the Phred (Q) scale. Read lengths are shown in thousands of basepairs.
Histograms on X and Y axes indicate the density of reads at respective quality scores and read lengths. (Plot generated by NanoPlot [@DeCoster2023])
:::

### Even abundance scenario {#sec-even-scenario}

#### Minimum cluster size threshold to recover the expected number of species {#sec-cluster-results}

The clustering approaches that were adopted aimed to group full ITS sequences from the same species together in the same OTU.
The total number of OTUs was used as a measure for successfully estimating the number of species in the mock community.
In this section we considered the even abundance mock community where 58 fungal taxa were equally represented (@sec-scenario-1).
Of the 58 taxa, some had the same species-level designation making for a total of 55 unique species.

Two clustering approaches were tested: a greedy sequence similarity-based clustering approach with VSEARCH and a k-mer signature based clustering approach (as implemented in NanoCLUST).
To recover the expected number of species from the mock community, both clustering approaches required a technique to filter out low-abundance OTUs.

The number of OTUs returned by VSEARCH at 97% sequence identity was consistently larger than the actual number of species present in the mock community.
VSEARCH significantly over-estimated the number of species in the mock community when no filtering was applied to the resulting set of OTUs.
A large proportion of OTUs had low abundance and this proportion increased dramatically as the library size increased.
For VSEARCH, to recover the expected number of species in the mock community, we implemented a crude cutoff which removed OTUs below a minimum size.
We set the cutoff to a proportion of the total library size we tested values between 0% and 2% (@fig-compareVsearchNanoclust).
We repeated the test for 6 different library sizes (1160, 2900, 9686, 58000, 116000, and 145000 reads) where each fungal taxa had an equal abundance.

With VSEARCH, we observed consistent behaviour when applying the minimum OTU size cutoff at all library sizes.
The number of OTUs would begin very high, then 'flatten out' near the expected number of species, then drop off.
We observed that setting the minimum OTU size to be 0.15% of the library size consistently recovered the expected number of species.

:::{#fig-compareVsearchNanoclust}
![](analysis/images/06-otu-count-and-loss.png)

Impact of a minimum OTU size cutoff on the number of OTUs and the proportion of read loss between NanoCLUST (in red) and VSEARCH (in blue) clustering methods.
These are results from the even abundance scenario.
Plots have been organised in columns by increasing library size.
The top row of plots shows the number of OTUs after applying a minimum cluster size cutoff that is a proportion of the library size.
The bottom row of plots show the proportion of reads that are lost after applying the minimum OTU size cutoff.
The mean values of each have been plotted after five random resamplings at each library size.
The dashed line indicates the actual number of species in the mock scenario.
:::

<!--
  :::{#fig-vsearchotus}
  ![](analysis/images/06-otu-count-vsearch.png)

  Effect of a minimum OTU size threshold on the number of OTUs when clustering with VSEARCH.
  Colours indicate the minimum OTU size threshold as a proportion of the total library size.
  The dashed line indicates the actual number of species in the mock scenario (55).
  Five repetitions were performed for each library size. X and Y axes are on a logarithmic scale.
  :::
-->

Alternatively, we tested the k-mer based clustering approach used by the NanoCLUST pipeline.
Within the NanoCLUST pipeline, HDBSCAN is the algorithm that performs the clustering and requires specifying a minimum cluster size parameter *a priori*.
<!-- The minimum cluster size parameter used by the HDBSCAN significantly impacts the resulting number of clusters by limiting the groupings that can be considered a cluster [@ParameterSelectionHDBSCAN].
-->
Similar to our approach with VSEARCH, we tested multiple values of HDBSCAN's minimum cluster size parameter on the even abundance mock community for 6 different library sizes (1160, 2900, 9686, 58000, 116000, and 145000 reads).
We tested a range of minimum cluster size parameters between 0% and 2% of the total library size.
We found that when the minimum cluster size parameter was set to its minimum value (2 reads), the NanoCLUST method overestimated the number of species for library sizes of 1160 reads and above.
With the minimum cluster size parameter set to 2, the number of OTUs increased in proportion to the library size but not as drastically as the number of unfiltered OTUs with VSEARCH.
For library sizes of 1160 reads and above, a minimum cluster size of 0.65% of the total library size consistently recovered the expected number of species.

<!--
  :::{#fig-nanoclustOTUs}

  ![](analysis/images/06-otu-count-nanoclust.png)

  Effect of minimum cluster size parameter and total library size on the number of OTUs when following the UMAP and HDBSCAN (NanoCLUST) clustering approach.
  Colours indicate the minimum cluster size parameter as a proportion of the total library size.
  The dashed line indicates the actual number of species in the mock dataset (55).
  Five repetitions were performed for each library size. X and Y axes are on a logarithmic scale.
  :::
-->

To aid the comparison of VSEARCH and NanoCLUST clustering methods, we recorded the proportion of reads that were lost due to defining a minimum OTU size.
We define the proportion of reads loss for VSEARCH as:

$$
\frac{\text{\# of reads removed when filtering OTUs by size}}{\text{\# number of reads in library}}
$$

and for Nanoclust as:

$$
\frac{\text{\# of unclustered reads}}{\text{\# number of reads in library}}
$$

We found that for low library sizes (1160-9686 reads), the NanoCLUST method produced closer estimates of the actual number of species
with lower read loss than VSEARCH for all minimum OTU size values (@fig-compareVsearchNanoclust).
For larger library sizes (58K-145K reads) using the VSEARCH method, we observed a consistent pattern read loss for the all library sizes.
The NanoCLUST method became less consistent for larger library sizes and lost a higher proportion reads to recover the same number of species (@fig-compareVsearchNanoclust).
<!--
For example, using the VSEARCH method, 5% of reads were lost when the minimum OTU size was set to 0.5% (of library size) for all library sizes.
While using the NanoCLUST method 2.5%, 0.6%, 0.75%
-->

<!--
For larger library sizes (50K-145K reads), the NanoCLUST method's minimum cluster size of 0.65% produced consistently
accurate estimates of the actual number of species while VSEARCH's minimum cluster threshold of 0.15% performed similarly.
When considering read loss at these thresholds, compared to VSEARCH, the NanoCLUST method performed better at a library size of 50K, similarly at a library size of 116K reads
and worse at a library size of 145K reads.
-->

#### Computing number of species after taxonomic assignments and fixed min cluster size cutoff

While we were able to demonstrate above that the expected number of species can be recovered by setting a minimum OTU size,
 number of OTUs may not be an accurate measure of the actual number of species.
For example one species may have been split into multiple OTUs which have all given the same species-level taxonomic assignment.
In addition, we wanted to explore using a minimum OTU size threshold that was not proportional to the library size.
We felt that a minimum OTU size of 0.65% for NanoCLUST and 0.15% for VSEARCH would exclude low abundance species
and may bias against samples with low read depth.

Here we explored the observed number of species in our even abundance mock community after OTUs had been given taxonomic assignments.
We performed VSEARCH and NanoCLUST clustering methods on four library sizes of 9686, 58000, 116000, 145000 reads.
HDBSCAN clustering was performed six times for each library with minimum cluster sizes of: 2, 5, 10, 20, 50 and 100 reads.
VSEARCH clustering was performed once for each library at 97% identity, then we remove OTUs with fewer than: 2, 5, 10, 20, 50 and 100 reads.
The most abundant sequence was used at the representative sequence for each OTU and given a taxonomic assignment with dnabarcoder.

For each minimum OTU size, we counted the number of unique taxonomic assignments given at the species level.
OTUs that were unidentified at the species level were counted as individual species (and not lumped together as a single species).
Of the OTUs that were given a species-level assignment, we counted the number of species that we knew were in the mock community (@tbl-samplesheet).
For OTUs that were only identified to genus or family level, we counted how many were expected in our mock community.
OTUs that were given a taxonomic label at species, genus or family levels but were not expected in the mock community were counted as false positives.
OTUs that were unidentified at the family level or higher were counted as their own group (@fig-fixed-min-cluster-size-even).
We also recorded the read loss after applying the minimum OTU size threshold as in the section above.


:::{#fig-fixed-min-cluster-size-even}
![](/analysis/images/06-n-species-even)

Number of species after 'collapsing' OTUs with the same species-level taxonomic assignment.
The even abundance mock community was clustered with VSEARCH and NanoCLUST.
:::

We found that a core set of correctly identified species remained regardless of minimum OTU size.
VSEARCH seemed to most heavily filter from 'correct' genus-level OTUs and OTUs unidentified from the family level.
NanoCLUST still overestimating the number of species regardless of min OTU size, but had the benefit of much lower read loss than VSEARCH.

- compare with number of OTUs

#### Comparing cluster delineation between VSEARCH and NanoCLUST

To investigate if closely related species were recovered during clustering, we looked at a single execution of the even abundance scenario (Scenario 1) where 2000 reads were selected
from each of the 58 fungal isolates giving a total library size of 116K reads.
Reads were clustered separately with the NanoCLUST and VSEARCH methods.
Reads that were clustered with the UMAP + HDBSCAN method (NanoCLUST) used a minimum cluster size of 580 (0.5% of the library size).
Reads were clustered using VSEARCH at 97% identity and clusters that had fewer than 174 reads (0.15% of library size) were removed.
Taxonomy was assigned to the most abundant sequence of each cluster with dnabarcoder and the UNITE+INSD 2024 reference database.

The samples from the order *Pucciniales* are shown in @fig-splittingPuccinia.
Using the NanoCLUST method, the majority of reads from the *Puccinia striiformis (var tritici)* sample (BC 25) clustered together into a single cluster (OTU 37) with the expected species-level classification (*Puccinia striiformis*).
The remaining reads from the *P. striiformis (var tritici)* sample clustered into two groups (1 read each) which do not correspond to the expected sample taxonomy.
The *Botrytis* genus classification of one of the clusters corresponds to another sample present in the library
and may be indicative of index-switching (where a sequencing error has occurred in the barcode region of the read).


:::{#fig-splittingPuccinia}
![](analysis/images/06-cluster-splitting-nanoclust-puccinia.png)

![](analysis/images/06-cluster-splitting-vsearch-puccinia.png)

Clustering of *Pucciniales* using the NanoCLUST (UMAP + HDBSCAN) vs VSEARCH methods.
Bars indicate the abundance of a cluster (number of reads).
The taxonomic classification given by dnabarcoder (with the UNITE 2024 database) for each cluster is shown in the x-axis labels.
Green bars indicate that the assignment given to a cluster matches the expected species-level classification.
Red bars indicate that the classification is incorrect for family-level and above.
Grey bars indicate that the cluster could not be given any taxonomic classification at all.
Bars marked with an asterix (*) indicate that taxonomic labels differed between reference database and our sample but were still considered the same species.
:::

In the *Puccinia graminis* sample (BC 27), when using the NanoCLUST method, the majority of the reads have been split into two clusters, both of which
have been classified as the expected *P. graminis* species.
Using the VSEARCH method, the majority of the *Puccinia graminis* reads cluster into a single correctly identified OTU.
This likely indicates biological variation in the sequences from the *P. graminis* sample that NanoCLUST is capable of detecting.
The majority of reads for both *Austropuccinia psidii* samples (BC 28 and 36) have been split into the same two clusters (OTU 38 and 21)
which have been given the classification *Puccinia psidii*.
A similar plot for all samples in this mock scenario can be seen in @fig-nanoclustSplitting2 and @tbl-tax-assignments-nanoclust.

- show results for:
  - Candida
    - consistent results between VSEARCH and NanoCLUST
    - BC53 + BC54 result same clusters
    - BC49 + BC50 unclassified
    - more noise in nanoclust
    - BC53 found in BC47 - potential contamination?
  - Cryptococcus
    - VSEARCH splits cryptococcus gatii VG I into 3 main clusters
        - shares cluster with C. neoformans VN IV
        - while nanoclust does not
    - VSEARCH OTU 9 present in all cryptococcuss samples
    - significant crossover of:
        - candida ortholopsis (BC54) found in Crypto. gattii VG III
        - kluveromyces marxianus (BC67) in C. neofarmans VNI
        - consistent in vsearch and nanoclust
  - Botrytis
    - share same OTU

:::{#fig-splittingCandida}
![](analysis/images/06-cluster-splitting-nanoclust-candida.png)

![](analysis/images/06-cluster-splitting-vsearch-candida.png)

Clustering of selected *Candida*
:::

:::{#fig-splittingBotrytis}
![](analysis/images/06-cluster-splitting-nanoclust-botrytis.png)

![](analysis/images/06-cluster-splitting-vsearch-botrytis.png)

Clustering of genus *Botrytis*
:::

:::{#fig-splittingBotrytis}
![](analysis/images/06-cluster-splitting-nanoclust-cryptococcus.png)

![](analysis/images/06-cluster-splitting-vsearch-cryptococcus.png)

Clustering of genus *Cryptococcus*
:::



#### OTU clumping


#### Comparison of taxonomic assignment using the most abundant sequence or the consensus sequence

In order to explore the accuracy of the taxonomic classifications in the pipeline, two metrics were computed for the even abundance mock scenario (Scenario 1).
The genera classification proportion metric has been defined as:

$$
\frac{\text{\# of reads classified at the genera level}}{\text{total \# of reads from isolate}}
$$

The genera precision metric has been defined as:

$$
\frac{\text{\# of reads classified correctly at the genera level}}{\text{\# of reads classified at the genera level}}
$$

These metrics were calculated for five library sizes (between 2900 and 145000 reads) for both NanoCLUST and VSEARCH clustering methods (@fig-nanoclustPrecisionAbundance).
We wanted to explore which representative sequence (most abundant or consensus) of each cluster gave more accurate taxonomic classifications.


Figure analysis:

- more variability with consensus sequences
- higher precision at lower classification proportion for lowest minimum cluster size (2)
- minimum cluster size introduces its own variability

:::{#fig-nanoclustPrecisionAbundance}

![](analysis/images/06-precision-even-abundance.png)

:::{custom-style="Caption"}
VSEARCH precision ...
:::

Most abundant sequence less variable in precision than consensus - VSEARCH
:::

- limitations of reference database labels, difficult to ensure taxonomic assignments are correct in an automated fashion.

### Uneven abundance Scenario

#### Minimum cluster size threshold to recover the expected number of species

:::{#fig-n-species-uneven}
![](analysis/images/06-n-species-uneven.png)


:::

#### Sensitivity of cluster thresholds in uneven abundance scenarios (Scenario 2)

- points at which we lose samples
- tradeoff -> inflated number of clusters / noisy
- min cluster size as proportion of library size not robust for uneven sampling approaches

:::{#fig-uneven-min-cluster-thresh-nanoclust}

![](analysis/images/06-uneven-min-cluster.png)

:::{custom-style="Caption"}
The impact of increasing the minimum cluster size parameter for NanoCLUST (UMAP + HDBSCAN) from left to right (values between 2 and 100).
Only clusters containing reads from the five 'low-abundance' fungal isolates are shown.
OTUs and their taxonomic classification (given by dnabarcoder) are shown on the x-axis.
As minimum cluster size increases, reads from 'low-abundance' fungal isolates are merged with those from
unrelated taxa (i.e. reads from *Eutypa lata* are clustered together with those identified as *Puccinia psidii* at minimum cluster size equal to 20).

:::

Impact of min_cluster_size on low abundance clusters in NanoCLUST
:::


## Soil samples

- demultiplexing with minibar
  - retained 70% of reads, from 4,365,488 to 3,041,450
  - of these:
    - 88599 reads had 'multiple barcode matches'
    - 1235439 reads had unidentifiable barcodes


### Quality control

:::{#fig-qc-soil}

![](analysis/images/06-read-loss-by-stage-by-sample-soil.png)

Read loss at each filtering and trimming stage of the pipeline. Each point represents a soil or control sample.
The blue horizontal bar with percentages indicate the mean proportion of reads lost from the previous step.
Four samples with the read count after quality control have been given colours: brown, green, pink and red.
Each step was executed in order from left to right. Note the y-axis has been plotted on a square root scale.
:::

- demultiplexing approach has already detected using primers, hence low read loss in primer trimming step compared to mock scenario.


:::{#fig-raw-read-quality-soil}
![](analysis/images/06-raw-read-quality-soil.png)

Mean read quality of reads from 25 soil samples before trimming or filtering steps.
The raw reads have been produced by a MinION R10.4.1 flow cell after basecalling with dorado v0.7.1 (super-high accuracy model).
Quality scores are in the Phred (Q) scale. Read lengths are shown in thousands of basepairs.
Histograms on X and Y axes indicate the density of reads at respective quality scores and read lengths. (Plot generated by NanoPlot [@DeCoster2023])
:::

### Clustering and taxonomic assignment

#### Effect of minimum cluster size on number of OTUs and number of species
